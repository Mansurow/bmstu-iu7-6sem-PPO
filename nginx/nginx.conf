worker_processes 1;
events {
    worker_connections 1024;
}

http {
    charset UTF-8;

    # балансировка GET запросов к /api/v1 (/api/v2)
    upstream portal {
        #server host.docker.internal:8080;
        server host.docker.internal:8080 weight=2; # основной бэкенд-сервер
        server host.docker.internal:8081 weight=1;
        server host.docker.internal:8079 weight=1;
    }

    # /mirror1
    upstream mirror_backend {
        server host.docker.internal:8078;
    }

    upstream pgadmin {
        server localhost:5000;
    }

    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=portalcache:10m max_size=1g;

    server {
        include mime.types;

        listen 80;
        server_name  portal;
 
        # Сжатие
        gzip on;
        ## Уровень сжатия
        gzip_comp_level 4;
        ## Мин длина сжатия
        gzip_min_length 20;
        ## Разрешает сжатие для проксированных запросов
        gzip_proxied  expired no-cache no-store private auth;
        ## Разрешает сжатие mime-типов
        gzip_types 
        text/plain 
        text/css 
        application/json 
        application/x-javascript 
        text/xml 
        application/xml 
        application/xml+rss 
        text/javascript 
        image/jpeg;

        # Кэширование
        proxy_cache portalcache;
        ## Шаблон построения  ключа кэширования
        proxy_cache_key "$host$request_uri$cookie_user";
        ## Мин количества запросов для начала кэширования
        proxy_cache_min_uses 1;
        ## Методы CRUD для кэширования
        proxy_cache_methods GET; 
        ## Не сохраняет в кэш
        proxy_no_cache $http_pragma    $http_authorization;
        ## Не отправляет кэшированные ответы клиентам
        proxy_cache_bypass $http_pragma    $http_authorization;
        ## Время кэша
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404      1m;
        proxy_cache_valid any      5m;


        # Настройка api версий 
        ## v1 - swagger
        ## v2 - graphql
        location ~ ^/api/v1/([^.]*)$ {  
            proxy_no_cache 1;
            proxy_pass 'http://portal/api/v1/$1';
        }

        location = /api/v1/ {
            proxy_no_cache 1;
            proxy_pass 'http://portal/swagger/';
        }

        location /api/v1/ {
            proxy_no_cache 1;
            proxy_pass 'http://portal/swagger/';
        }

        location /api/v2/ {
            proxy_no_cache 1;
            proxy_pass 'http://portal/graphql/'; 
        }

        # Настройка mirror
        location /mirror1/ {
            proxy_pass http://mirror_backend;
        }

        location ~ ^/mirror1/api/v1/([^.]*)$ {  
            proxy_no_cache 1;
            proxy_pass 'http://mirror_backend/api/v1/$1';
        }

        location = /mirror1/api/v1/ {
            proxy_no_cache 1;
            proxy_pass 'http://mirror_backend/swagger/';
        }

        location /mirror1/api/v1/ {
            proxy_no_cache 1;
            proxy_pass 'http://mirror_backend/swagger/';
        }

        location /mirror1/api/v2/ {
            proxy_no_cache 1;
            proxy_pass 'http://mirror_backend/graphql/'; 
        }

        # Настройка pgadmin
        location /admin/ {
            #return 301 'http://$host:5050/';
            proxy_pass 'http://pgadmin/';
		}

        # Настройка вывода главной страницы
        location / {
            root '/usr/share/nginx/static';
            index 'index.html';
        }

        location /static {
            root '/usr/share/nginx/';
        }

        location /status {
            stub_status;
        }

        # Настройка README.md с визуализацией
        location /documentation {
            #root '/usr/share/nginx/docs/';
            #try_files '/README.md' '/README.md';
            root '/usr/share/nginx/';
            index 'render.html';
        }

        location /apache {
            root '/usr/share/nginx';
            index 'render.html';
        }

        location /test {
            root '/usr/share/nginx/static';
            index 'index.html';
        }
    }
}