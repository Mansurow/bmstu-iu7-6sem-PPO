worker_processes 4;
events {
    worker_connections 4024;
}

http {
    charset UTF-8;

    # балансировка GET запросов к /api/v1 (/api/v2)
    upstream portal_get {
        #server host.docker.internal:8080;
        server host.docker.internal:8080 weight=2; # основной бэкенд-сервер
        server host.docker.internal:8081;
        server host.docker.internal:8079;
    }

    upstream portal {
        server host.docker.internal:8080;
    }

    # /mirror1
    upstream mirror_backend {
        server host.docker.internal:8078;
    }

    upstream pgadmin {
        server localhost:5000;
    }

    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=portalcache:10m max_size=1g;

    server {
        include mime.types;

        listen 80;
        listen [::]:80;

        server_tokens off;

        #server_name portal.ru;
        proxy_pass_header Server;
        proxy_set_header Server server;
        add_header Server "portal" always;

        # Сжатие
        gzip on;
        ## Уровень сжатия
        gzip_comp_level 4;
        ## Мин длина сжатия
        gzip_min_length 20;
        ## Разрешает сжатие для проксированных запросов
        gzip_proxied  expired no-cache no-store private auth;
        ## Разрешает сжатие mime-типов
        gzip_types 
        text/plain 
        text/css 
        application/json 
        application/x-javascript 
        text/xml 
        application/xml 
        application/xml+rss 
        text/javascript 
        image/jpeg;

        # Кэширование
        proxy_cache portalcache;
        ## Шаблон построения  ключа кэширования
        proxy_cache_key "$host$request_uri$cookie_user";
        ## Мин количества запросов для начала кэширования
        proxy_cache_min_uses 1;
        ## Методы CRUD для кэширования
        proxy_cache_methods GET; 
        ## Не сохраняет в кэш
        proxy_no_cache $http_pragma    $http_authorization;
        ## Не отправляет кэшированные ответы клиентам
        proxy_cache_bypass $http_pragma    $http_authorization;
        ## Время кэша
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404      1m;
        proxy_cache_valid any      5m;


        # Настройка api версий 
        ## v1 - swagger
        ## v2 - graphql
        location ~ ^/api/v1/([^.]*)$ {  
            proxy_no_cache 1;
            if ($request_method = GET) {
                proxy_pass 'http://portal_get/api/v1/$1$is_args$args';
            }

            proxy_pass 'http://portal/api/v1/$1$is_args$args';
        }
        
        location = /api/v1/ {
            proxy_no_cache 1;
            proxy_pass 'http://portal/swagger/';
        }

        location /api/v1/ {
            proxy_no_cache 1;
            proxy_pass 'http://portal/swagger/';
        }

        location /api/v2/ {
            proxy_no_cache 1;
            proxy_pass 'http://portal/graphql/'; 
        }

        # Настройка mirror
        location /mirror1/ {
            proxy_pass http://mirror_backend;
        }

        location ~ ^/mirror1/api/v1/([^.]*)$ {  
            proxy_no_cache 1;
            proxy_pass 'http://mirror_backend/api/v1/$1$is_args$args';
        }

        location = /mirror1/api/v1/ {
            proxy_no_cache 1;
            proxy_pass 'http://mirror_backend/swagger/';
        }

        location /mirror1/api/v1/ {
            proxy_no_cache 1;
            proxy_pass 'http://mirror_backend/swagger/';
        }

        location /mirror1/api/v2/ {
            proxy_no_cache 1;
            proxy_pass 'http://mirror_backend/graphql/'; 
        }

        # Настройка pgadmin
        location /admin/ {
            return 301 'http://$host:5050/';
            #proxy_pass 'http://pgadmin/';
		}

        # Настройка вывода главной страницы
        location / {
            root '/usr/share/nginx/static';
            index 'index.html';
        }

        location /static {
            root '/usr/share/nginx/';
        }

        location /status {
            stub_status;
        }

        # Настройка README.md с визуализацией
        location /documentation {
            #root '/usr/share/nginx/docs/';
            #try_files '/README.md' '/README.md';
            root '/usr/share/nginx/';
            index 'render.html';
        }

        location /apache {
            root '/usr/share/nginx';
            index 'render.html';
        }

        location /test {
            root '/usr/share/nginx/static';
            index 'index.html';
        }
    }


    server {
        listen 443 ssl;
        listen [::]:443 ssl;

        http2 on;

        server_name http2.portal.ru;

        ssl_certificate /etc/nginx/ssl/localhost.crt;
        ssl_certificate_key /etc/nginx/ssl/localhost.key;
        ssl_session_timeout  5m;

        # Настройка вывода главной страницы
        location / {
            root '/usr/share/nginx/static';
            index 'index.html';
            http2_push 'img/signin.png';
        }
    }

    # server {
    #     listen 443 quic reuseport;
    #     listen 443 ssl;
    
    #     http3 on;
    #     server_name http3.portal.ru;

    #     ssl_certificate /etc/nginx/ssl/localhost.crt;
    #     ssl_certificate_key /etc/nginx/ssl/localhost.key;
    #     ssl_protocols TLSv1.3;
    #     ssl_session_timeout  5m;

    #     add_header Alt-Svc 'h3=":8443"; ma=86400';

    #     # Настройка вывода главной страницы
    #     location / {
    #         root '/usr/share/nginx/static';
    #         index 'index.html';
    #     }
    # }
}